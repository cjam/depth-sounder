<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Depth Sounder</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous"/>
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
          integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous"/>

    <link href="/static/switch/css/bootstrap-switch.min.css" rel="stylesheet">

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"/>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="/static/jquery-mobile-ext/vertical-slider-extension.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>

    <script src="/static/switch/js/bootstrap-switch.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout.mapping/2.4.1/knockout.mapping.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>


    <style>
        .container {
            background: #fff;
        }

        #alert {
            display: none;
        }

        #sl2 {
            width: 400px;
        }

        #RGB {
            height: 20px;
            background: rgb(128, 128, 128);
        }

        #RC .slider-selection {
            background: #FF8282;
        }

        #RC .slider-handle {
            background: red;
        }

        #GC .slider-selection {
            background: #428041;
        }

        #GC .slider-handle {
            background: green;
        }

        #BC .slider-selection {
            background: #8283FF;
        }

        #BC .slider-handle {
            border-bottom-color: blue;
        }

        #R, #G, #B {
            width: 300px;
        }

        #eg .slider-selection {
            background: #BABABA;
        }
    </style>

    <script type="text/javascript">

        ko.bindingHandlers.slider = {
            init: function (element, valueAccessor, bindings, viewModel, bindingContext) {
                $(element).bind('change', function (evt, ui) {
                    valueAccessor()(parseFloat($(element).val()));
                });
                $(element).slider();
            },
            update: function (element, valueAccessor, bindings, viewModel, bindingContext) {
                $(element).val(parseFloat(ko.unwrap(valueAccessor())));
                $(element).slider('refresh');
            }
        };

        ko.bindingHandlers.bootstrapSwitch = {
            init: function (element, valueAccessor, allBindingsAccessor) {
                //initialize bootstrapSwitch
                $(element).bootstrapSwitch();

                // setting initial value
                $(element).bootstrapSwitch('state', valueAccessor());

                //handle the field changing
                $(element).on('switchChange.bootstrapSwitch', function (event, state) {
                    var observable = valueAccessor();
                    observable(state);
                });

                // Adding component options
                var options = allBindingsAccessor().bootstrapSwitchOptions || {};
                for (var property in options) {
                    $(element).bootstrapSwitch(property, ko.utils.unwrapObservable(options[property]));
                }

                //handle disposal (if KO removes by the template binding)
                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $(element).bootstrapSwitch("destroy");
                });

            },
            //update the control when the view model changes
            update: function (element, valueAccessor, allBindingsAccessor) {
                var value = ko.utils.unwrapObservable(valueAccessor());

                // Adding component options
                var options = allBindingsAccessor().bootstrapSwitchOptions || {};
                for (var property in options) {
                    $(element).bootstrapSwitch(property, ko.utils.unwrapObservable(options[property]));
                }

                $(element).bootstrapSwitch("state", value);
            }
        };

        $(document).ready(function () {

            var namespace = "/"
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

            // a bit of a hack to avoid emissions
            var isUpdating = false

            function emit(message, data) {
                if (!isUpdating) {
                    socket.emit(message, data);
                }
            }

            function ChannelViewModel(data) {
                ko.mapping.fromJS(data, {}, this);
                this.gain.subscribe(function (val) {
                    console.log("gain changed:", val)
                    emit('update_channel', ko.mapping.toJS(this))
                }, this);

                this.enabled.subscribe(function (val) {
                    emit('update_channel', ko.mapping.toJS(this))
                }, this);
            }

            function MixerViewModel(data) {
                var self = this;

                // mapping for object model binding
                var mapping = {
                    'channels': {
                        key: function (data) {
                            console.log("Channel", data)
                            return ko.utils.unwrapObservable(data.id)
                        }
                        , create: function (options) {
                            return new ChannelViewModel(options.data);
                        }
                    }
                }

                self.apply = function (data) {
                    ko.mapping.fromJS(data, mapping, self);
                }

                self.apply(data);

                this.isPlaying.subscribe(function (val) {
                    if (val) {
                        emit("start_audio");
                    } else {
                        emit("stop_audio");
                    }
                })
            }

            // Note: this will block until the server finishes rendering the initial model
            var mixerViewModel;

            socket.on("model_changed", function (data) {
                console.log("model changed:", data)
                isUpdating = true;
                if (!mixerViewModel) {
                    mixerViewModel = new MixerViewModel(data)
                    ko.applyBindings(mixerViewModel, $("#MixerView")[0]);
                } else {
                    mixerViewModel.apply(data);
                }
                isUpdating = false;
            });


            function DeviceMotionAdapter(updateInterval) {
                self = this;

                this.isSupported = new ko.observable(false);
                this.isTracking = new ko.observable(false);

                // Check if mobile
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && window.DeviceOrientationEvent) {
                    this.isSupported(true);
                }

                var deviceInfo = {
                    motion: {},
                    orientation: {}
                }

                var deviceSocket = io("/device")
                deviceSocket.on('connect', function (evt) {
                    deviceInfo.id = deviceSocket.id;
                });


                if (this.isSupported()) {


                    var pushDeviceInfo = function () {
                        if (self.isTracking()) {
                            deviceSocket.emit("changed", deviceInfo);
                        }
                    }

                    var handleMotionEvent = function (event) {
                        deviceInfo.motion = event;
                    }

                    var handleOrientationEvent = function (event) {
                        deviceInfo.orientation = event;
                    }

                    window.addEventListener("devicemotion", handleMotionEvent, true);
                    window.addEventListener("deviceorientation", handleOrientationEvent, true);

                    updateInterval = updateInterval ? updateInterval : 1000;
                    setInterval(pushDeviceInfo, updateInterval)
                }
            };
            var deviceMotionAdapter = new DeviceMotionAdapter();
            ko.applyBindings(deviceMotionAdapter, $("#DeviceInfoView")[0])
        });
    </script>
</head>
<body>
<H1>Depth Sounder</H1>
<div id="DeviceInfoView" class="well col-md-4" data-bind="visible:isSupported">
    <input type="checkbox" data-bind="bootstrapSwitch: isTracking,attr:{'data-label-text': name}"
           data-size="Large"
           data-off-text="Track"
           data-off-color="success"
           data-on-text="Stop"
           data-on-Color="danger"
           data-label="Motion"/>
</div>

<div id="MixerView">
    <div class="well col-md-8">
        <input type="checkbox" data-bind="bootstrapSwitch: isPlaying,attr:{'data-label-text': name}"
               data-size="Large"
               data-off-text="Play"
               data-off-color="success"
               data-on-text="Stop"
               data-on-Color="danger"
               data-label-width="5"/>
    </div>
    <div class="well">
        <table>
            <tbody>
            <tr data-bind="foreach: channels">
                <td style="width:100px;">
                    <div>
                        <h3 data-bind="text: name"></h3>
                        <input type="checkbox" data-bind="bootstrapSwitch: enabled,attr:{'data-label-text': name}"
                               data-size="mini"
                               data-on-color="success"
                               data-off-Color="danger"
                               data-label-width="5"/>
                        <input data-vertical="true" data-bind="slider: gain" min="0.0" step="0.05" max="5.0"
                               data-highlight="true">
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>
</body>
</html>